---
title: "Using the chessR Package"
author: "Jason Zivkovic"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the chessR Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message=FALSE,
  warning=FALSE
)
```


## Installation

You can install the chessR package from github with:

```{r gh-installation}
# devtools::install_github("JaseZiv/chessR")
library(chessR)
```

```{r packages_for_eda, include=FALSE}
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)
library(scales)
```


## Usage

The functions available in this package are designed to enable the extraction of chess game data.

### Data Extraction

The functions detailed below relate to extracting data from chess.com

#### Raw Game Data

The `get_raw_chessdotcom` function can take either a single, or multiple usernames. It will output a data frame with all the games played by that user. The function replaces `get_raw_game_data` from version 1.1.0


```{r get_raw}
raw_chessdotcom <- get_raw_chessdotcom("JaseZiv")
```

```{r inspect_raw}
glimpse(raw_chessdotcom)
```

#### Analysis Data

The following function will extract the same data that the `get_raw_chessdotcom()` function will, however this function will also include additional columns to make analysing data easier.

The function can be used either on a single player, or a character vector of multiple players.

```{r get_analysis}
chess_analysis_single <- get_game_data("JaseZiv")
```

```{r inspect_analysis}
glimpse(chess_analysis_single)
```


### Extract Leaderboards

The below function allows the user to extract the top 50 leaders on the chess.com leaderboards for a number of different game types.

The game types include:

> *"daily", "daily960", "live_rapid", "live_blitz", "live_bullet", "live_bughouse", "live_blitz960", "live_threecheck", "live_crazyhouse", "live_kingofthehill", "lessons" and "tactics"*.

The usernames that are contained in the results can then be passed to `get_raw_chessdotcom()` outlined above.

```{r get_leaders}
daily_leaders <- chessdotcom_leaderboard(game_type = "daily")
```

```{r inspect_leaders}
glimpse(daily_leaders)
```

### Analysis Functions

This section will detail some of the function to use for analysis and extracting information from the raw games data extracts.

#### Number of moves in the game

To be able to see how many moves a game lasted, the `return_num_moves` function can be used.

It will parse through the *Moves* column in the extracted data frame and return a vector of moves, each one being for each game.

```{r num_moves}
# function to extract the number of moves in each game
raw_chessdotcom$nMoves <- return_num_moves(moves_string = raw_chessdotcom$Moves)

# inspect output
head(raw_chessdotcom[, c("Moves", "nMoves")])
```

#### How the game ended

The chess.com data extract doesn't have how the game ended on its own. To get the game ending on its own, the `get_game_ending` function can be used.

```{r game_ending}
# function to extract the ending of chess.com data
raw_chessdotcom$Ending <- get_game_ending(termination_string = raw_chessdotcom$Termination, 
                                          white = raw_chessdotcom$White, 
                                          black = raw_chessdotcom$Black)

# inspect output
head(raw_chessdotcom[, c("Termination", "White", "Black", "Ending")])
```


#### Game Winner

Given two players, one playing on white and the other on black, we want to be able to know the username of the winner. To get this information, use the `get_winner` function.

```{r get_winner}
# function to extract the winner of each game
raw_chessdotcom$Winner <- get_winner(result_column = raw_chessdotcom$Result, 
                                     white = raw_chessdotcom$White, 
                                     black = raw_chessdotcom$Black)

# inspect output
head(raw_chessdotcom[, c("White", "Black", "Result", "Winner")])
```


## Bonus: Basic EDA Analysing Games

This section will perform some exploratory data analysis on the analysis data set provided by `get_game_data()`. It is by no means an exhaustive list of topics to analyse, rather, it is designed to give the user a few ideas of what can be done with the analysis data provided.

```{r popular_times}
chess_analysis_single %>% 
  count(time_class) %>% 
  ggplot(aes(x= reorder(time_class,n), y= n)) +
  geom_col(fill = "steelblue", colour = "grey40", alpha = 0.7) +
  labs(x= "Game Style", y= "Number of Games") +
  ggtitle("WHICH TIME CLASSES ARE PLAYED MOST") +
  coord_flip() +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())
```


```{r user_result}
chess_analysis_single %>%
  mutate(MonthEnd = paste(year(EndDate), str_pad(lubridate::month(ymd(EndDate)), 2, side = "left", pad = "0"), sep = "-")) %>% 
  group_by(MonthEnd, UserResult) %>% 
  summarise(n = n()) %>% 
  mutate(WinPercentage = n / sum(n)) %>% 
  filter(UserResult == "Win") %>% 
  ggplot(aes(x= MonthEnd, y= WinPercentage, group=1)) +
  geom_line(colour= "steelblue", size=1) +
  geom_hline(yintercept = 0.5, linetype = 2, colour = "grey40") +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  labs(x= "Month Game Ended", y= "Win %") +
  ggtitle("MONTHLY WINNING %") +
  theme_minimal()
```



```{r monthly_elo, fig.width=9}
chess_analysis_single %>%
  filter(time_class %in% c("blitz", "daily")) %>% 
  mutate(MonthEnd = paste(year(EndDate), str_pad(lubridate::month(ymd(EndDate)), 2, side = "left", pad = "0"), sep = "-")) %>% 
  group_by(MonthEnd, time_class) %>% 
  summarise(AverageELO = mean(UserELO, na.rm = T)) %>% 
  ggplot(aes(x= MonthEnd, y= AverageELO, group=1)) +
  geom_line(colour= "steelblue", size=1) +
  labs(x= "Month Game Ended", y= "Average ELO") +
  ggtitle("MONTHLY AVERAGE ELO RATING") +
  facet_wrap(~ time_class, scales = "free_y", ncol = 1) +
  theme_minimal()
```


```{r opponet_elo_results}
chess_analysis_single %>% 
  filter(time_class %in% c("blitz", "daily")) %>% 
  ggplot(aes(x= OpponentELO, fill = UserResult)) +
  geom_density(alpha = 0.3) +
  ggtitle("HOW DO WE FARE AGAINST DIFFERENT ELOs?") +
  facet_wrap(~ time_class, scales = "free", ncol = 1) +
  theme_minimal()

```



